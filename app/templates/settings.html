<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Local Web Transcriber 設定" />
  <!-- セキュリティヘッダー -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="X-Frame-Options" content="DENY" />
  <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
  
  <title>設定 - Local Web Transcriber</title>
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-hover: #1d4ed8;
      --success-color: #16a34a;
      --warning-color: #d97706;
      --error-color: #dc2626;
      --border-color: #e5e7eb;
      --text-color: #374151;
      --text-muted: #6b7280;
      --bg-card: #ffffff;
      --bg-hover: #f9fafb;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      background-color: #f8fafc;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .header h1 {
      color: var(--primary-color);
      margin-bottom: 8px;
      font-weight: 700;
    }
    
    .header p {
      color: var(--text-muted);
      margin: 0;
    }
    
    .nav {
      margin-bottom: 32px;
      text-align: center;
    }
    
    .nav a {
      display: inline-block;
      padding: 8px 16px;
      margin: 0 8px;
      text-decoration: none;
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    
    .nav a:hover {
      background-color: var(--primary-color);
      color: white;
    }
    
    .nav a.active {
      background-color: var(--primary-color);
      color: white;
    }
    
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
    }
    
    .card h2 {
      margin-top: 0;
      margin-bottom: 20px;
      color: var(--text-color);
      font-weight: 600;
      font-size: 1.25rem;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group:last-child {
      margin-bottom: 0;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-color);
    }
    
    .form-help {
      margin-top: 4px;
      font-size: 0.875rem;
      color: var(--text-muted);
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background-color: white;
    }
    
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .form-select {
      cursor: pointer;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 48px;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background-color: var(--primary-hover);
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background-color: var(--border-color);
      color: var(--text-color);
    }
    
    .btn-secondary:hover:not(:disabled) {
      background-color: #d1d5db;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .btn-group .btn {
      flex: 1;
    }
    
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    
    .alert-success {
      background-color: #d1fae5;
      border: 1px solid #a7f3d0;
      color: #065f46;
    }
    
    .alert-error {
      background-color: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
    }
    
    .alert-warning {
      background-color: #fef3c7;
      border: 1px solid #fde68a;
      color: #92400e;
    }
    
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    
    @media (max-width: 768px) {
      .settings-grid {
        grid-template-columns: 1fr;
      }
      
      body {
        padding: 16px;
      }
      
      .btn-group {
        flex-direction: column;
      }
    }
    
    .model-info {
      display: grid;
      grid-template-columns: auto 1fr auto auto;
      gap: 12px;
      padding: 12px;
      background-color: var(--bg-hover);
      border-radius: 6px;
      margin-top: 8px;
      font-size: 0.875rem;
    }
    
    .model-info .label {
      font-weight: 500;
      color: var(--text-color);
    }
    
    .model-info .value {
      color: var(--text-muted);
    }
    
    .current-status {
      background-color: #eff6ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .current-status h3 {
      margin: 0 0 12px 0;
      color: var(--primary-color);
      font-size: 1rem;
      font-weight: 600;
    }
    
    .status-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .status-item:last-child {
      margin-bottom: 0;
    }
    
    .status-label {
      font-weight: 500;
      color: var(--text-color);
    }
    
    .status-value {
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>⚙️ 設定</h1>
    <p>Local Web Transcriber の各種設定を変更できます</p>
  </div>

  <div class="nav">
    <a href="/">🏠 ホーム</a>
    <a href="/settings" class="active">⚙️ 設定</a>
  </div>

  <!-- アラート表示エリア -->
  <div id="alert-container"></div>

  <!-- 現在のステータス -->
  <div class="card">
    <h2>📊 現在のステータス</h2>
    <div class="current-status" id="current-status">
      <h3>システム情報</h3>
      <div id="status-content">読み込み中...</div>
    </div>
  </div>

  <!-- 設定フォーム -->
  <div class="settings-grid">
    <!-- モデル設定 -->
    <div class="card">
      <h2>🤖 モデル設定</h2>
      <form id="model-form">
        <div class="form-group">
          <label for="model_id" class="form-label">Whisperモデル</label>
          <select name="model_id" id="model_id" class="form-select">
            <option value="">読み込み中...</option>
          </select>
          <div class="form-help">
            モデルサイズが大きいほど精度が高くなりますが、処理時間も長くなります
          </div>
          <div id="selected-model-info" class="model-info" style="display: none;">
            <span class="label">サイズ:</span>
            <span class="value" id="model-size">-</span>
            <span class="label">速度:</span>
            <span class="value" id="model-speed">-</span>
          </div>
        </div>

        <div class="form-group">
          <label for="compute_type" class="form-label">計算精度</label>
          <select name="compute_type" id="compute_type" class="form-select">
            <option value="int8">int8 (推奨 - 高速)</option>
            <option value="int8_float16">int8_float16 (バランス)</option>
            <option value="float16">float16 (高精度)</option>
            <option value="float32">float32 (最高精度)</option>
          </select>
          <div class="form-help">
            int8が最も高速で、float32が最も高精度です
          </div>
        </div>
      </form>
    </div>

    <!-- デフォルト設定 -->
    <div class="card">
      <h2>🌐 デフォルト設定</h2>
      <form id="defaults-form">
        <div class="form-group">
          <label for="default_language" class="form-label">デフォルト言語</label>
          <select name="default_language" id="default_language" class="form-select">
            <option value="">読み込み中...</option>
          </select>
          <div class="form-help">
            新規文字起こし時のデフォルト言語設定
          </div>
        </div>

        <div class="form-group">
          <label for="default_task" class="form-label">デフォルトタスク</label>
          <select name="default_task" id="default_task" class="form-select">
            <option value="transcribe">文字起こし</option>
            <option value="translate">翻訳（日本語）</option>
          </select>
          <div class="form-help">
            新規処理時のデフォルトタスク設定
          </div>
        </div>

        <div class="form-group">
          <label for="max_workers" class="form-label">最大同時処理数</label>
          <select name="max_workers" id="max_workers" class="form-select">
            <option value="1">1 (最も安定)</option>
            <option value="2">2 (推奨)</option>
            <option value="3">3 (高性能PC向け)</option>
            <option value="4">4 (ハイエンド)</option>
          </select>
          <div class="form-help">
            同時に実行できる文字起こし処理の数
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- 操作ボタン -->
  <div class="card">
    <div class="btn-group">
      <button type="button" class="btn btn-secondary" onclick="loadCurrentConfig()">
        🔄 設定を再読み込み
      </button>
      <button type="button" class="btn btn-primary" onclick="saveConfig()">
        💾 設定を保存
      </button>
    </div>
  </div>

  <script>
    let currentConfig = {};
    let availableModels = [];
    let availableLanguages = [];

    // アラート表示
    function showAlert(message, type = 'success') {
      const container = document.getElementById('alert-container');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      
      container.innerHTML = '';
      container.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    // 現在の設定を読み込み
    async function loadCurrentConfig() {
      try {
        const response = await fetch('/api/config');
        currentConfig = await response.json();
        
        // フォームに設定値を反映
        document.getElementById('model_id').value = currentConfig.model_id || '';
        document.getElementById('compute_type').value = currentConfig.compute_type || 'int8';
        document.getElementById('default_language').value = currentConfig.default_language || '';
        document.getElementById('default_task').value = currentConfig.default_task || 'transcribe';
        document.getElementById('max_workers').value = currentConfig.max_workers || 2;
        
        updateModelInfo();
        showAlert('設定を読み込みました', 'success');
      } catch (error) {
        console.error('Failed to load config:', error);
        showAlert('設定の読み込みに失敗しました: ' + error.message, 'error');
      }
    }

    // モデル一覧を読み込み
    async function loadModels() {
      try {
        const response = await fetch('/api/models');
        availableModels = await response.json();
        
        const select = document.getElementById('model_id');
        select.innerHTML = '';
        
        availableModels.forEach(model => {
          const option = document.createElement('option');
          option.value = model.id;
          option.textContent = `${model.id} (${model.size})`;
          select.appendChild(option);
        });
        
        // 現在の設定値を反映
        if (currentConfig.model_id) {
          select.value = currentConfig.model_id;
        }
        
        updateModelInfo();
      } catch (error) {
        console.error('Failed to load models:', error);
        showAlert('モデル一覧の読み込みに失敗しました', 'error');
      }
    }

    // 言語一覧を読み込み
    async function loadLanguages() {
      try {
        const response = await fetch('/api/languages');
        availableLanguages = await response.json();
        
        const select = document.getElementById('default_language');
        select.innerHTML = '';
        
        availableLanguages.forEach(lang => {
          const option = document.createElement('option');
          option.value = lang.code;
          option.textContent = lang.name;
          select.appendChild(option);
        });
        
        // 現在の設定値を反映
        if (currentConfig.default_language) {
          select.value = currentConfig.default_language;
        }
      } catch (error) {
        console.error('Failed to load languages:', error);
        showAlert('言語一覧の読み込みに失敗しました', 'error');
      }
    }

    // システムステータスを読み込み
    async function loadSystemStatus() {
      try {
        const response = await fetch('/api/status');
        const status = await response.json();
        
        const content = document.getElementById('status-content');
        content.innerHTML = `
          <div class="status-item">
            <span class="status-label">システム状態:</span>
            <span class="status-value">${status.status === 'running' ? '🟢 動作中' : '🔴 停止中'}</span>
          </div>
          <div class="status-item">
            <span class="status-label">モデル読み込み:</span>
            <span class="status-value">${status.model_loaded ? '🟢 済み' : '🟡 未読み込み'}</span>
          </div>
          <div class="status-item">
            <span class="status-label">処理中ジョブ:</span>
            <span class="status-value">${status.active_jobs} 件</span>
          </div>
          <div class="status-item">
            <span class="status-label">総ジョブ数:</span>
            <span class="status-value">${status.total_jobs} 件</span>
          </div>
          <div class="status-item">
            <span class="status-label">現在のモデル:</span>
            <span class="status-value">${status.current_config.model_id || 'base'}</span>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load system status:', error);
        document.getElementById('status-content').innerHTML = '⚠️ ステータスの読み込みに失敗しました';
      }
    }

    // モデル情報を更新
    function updateModelInfo() {
      const modelSelect = document.getElementById('model_id');
      const infoDiv = document.getElementById('selected-model-info');
      const selectedModel = availableModels.find(m => m.id === modelSelect.value);
      
      if (selectedModel) {
        document.getElementById('model-size').textContent = selectedModel.size;
        document.getElementById('model-speed').textContent = selectedModel.speed;
        infoDiv.style.display = 'grid';
      } else {
        infoDiv.style.display = 'none';
      }
    }

    // 設定を保存
    async function saveConfig() {
      try {
        const formData = {
          model_id: document.getElementById('model_id').value,
          compute_type: document.getElementById('compute_type').value,
          default_language: document.getElementById('default_language').value,
          default_task: document.getElementById('default_task').value,
          max_workers: parseInt(document.getElementById('max_workers').value)
        };
        
        const response = await fetch('/api/config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        showAlert(result.message, 'success');
        
        // システムステータスを更新
        setTimeout(loadSystemStatus, 1000);
        
      } catch (error) {
        console.error('Failed to save config:', error);
        showAlert('設定の保存に失敗しました: ' + error.message, 'error');
      }
    }

    // イベントリスナー
    document.getElementById('model_id').addEventListener('change', updateModelInfo);

    // ページ読み込み時の初期化
    document.addEventListener('DOMContentLoaded', async function() {
      await loadCurrentConfig();
      await loadModels();
      await loadLanguages();
      await loadSystemStatus();
      
      // 定期的にシステムステータスを更新
      setInterval(loadSystemStatus, 10000);
    });
  </script>
</body>
</html>
