<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Local Web Transcriber è¨­å®š" />
  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="X-Frame-Options" content="DENY" />
  <meta http-equiv="X-XSS-Protection" content="1; mode=block" />
  
  <title>è¨­å®š - Local Web Transcriber</title>
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-hover: #1d4ed8;
      --success-color: #16a34a;
      --warning-color: #d97706;
      --error-color: #dc2626;
      --border-color: #e5e7eb;
      --text-color: #374151;
      --text-muted: #6b7280;
      --bg-card: #ffffff;
      --bg-hover: #f9fafb;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      background-color: #f8fafc;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .header h1 {
      color: var(--primary-color);
      margin-bottom: 8px;
      font-weight: 700;
    }
    
    .header p {
      color: var(--text-muted);
      margin: 0;
    }
    
    .nav {
      margin-bottom: 32px;
      text-align: center;
    }
    
    .nav a {
      display: inline-block;
      padding: 8px 16px;
      margin: 0 8px;
      text-decoration: none;
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    
    .nav a:hover {
      background-color: var(--primary-color);
      color: white;
    }
    
    .nav a.active {
      background-color: var(--primary-color);
      color: white;
    }
    
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
    }
    
    .card h2 {
      margin-top: 0;
      margin-bottom: 20px;
      color: var(--text-color);
      font-weight: 600;
      font-size: 1.25rem;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group:last-child {
      margin-bottom: 0;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-color);
    }
    
    .form-help {
      margin-top: 4px;
      font-size: 0.875rem;
      color: var(--text-muted);
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background-color: white;
    }
    
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .form-select {
      cursor: pointer;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 48px;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background-color: var(--primary-hover);
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background-color: var(--border-color);
      color: var(--text-color);
    }
    
    .btn-secondary:hover:not(:disabled) {
      background-color: #d1d5db;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .btn-group .btn {
      flex: 1;
    }
    
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    
    .alert-success {
      background-color: #d1fae5;
      border: 1px solid #a7f3d0;
      color: #065f46;
    }
    
    .alert-error {
      background-color: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
    }
    
    .alert-warning {
      background-color: #fef3c7;
      border: 1px solid #fde68a;
      color: #92400e;
    }
    
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    
    @media (max-width: 768px) {
      .settings-grid {
        grid-template-columns: 1fr;
      }
      
      body {
        padding: 16px;
      }
      
      .btn-group {
        flex-direction: column;
      }
    }
    
    .model-info {
      display: grid;
      grid-template-columns: auto 1fr auto auto;
      gap: 12px;
      padding: 12px;
      background-color: var(--bg-hover);
      border-radius: 6px;
      margin-top: 8px;
      font-size: 0.875rem;
    }
    
    .model-info .label {
      font-weight: 500;
      color: var(--text-color);
    }
    
    .model-info .value {
      color: var(--text-muted);
    }
    
    .current-status {
      background-color: #eff6ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .current-status h3 {
      margin: 0 0 12px 0;
      color: var(--primary-color);
      font-size: 1rem;
      font-weight: 600;
    }
    
    .status-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .status-item:last-child {
      margin-bottom: 0;
    }
    
    .status-label {
      font-weight: 500;
      color: var(--text-color);
    }
    
    .status-value {
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>âš™ï¸ è¨­å®š</h1>
    <p>Local Web Transcriber ã®å„ç¨®è¨­å®šã‚’å¤‰æ›´ã§ãã¾ã™</p>
  </div>

  <div class="nav">
    <a href="/">ğŸ  ãƒ›ãƒ¼ãƒ </a>
    <a href="/settings" class="active">âš™ï¸ è¨­å®š</a>
  </div>

  <!-- ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div id="alert-container"></div>

  <!-- ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
  <div class="card">
    <h2>ğŸ“Š ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
    <div class="current-status" id="current-status">
      <h3>ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h3>
      <div id="status-content">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>

  <!-- è¨­å®šãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="settings-grid">
    <!-- ãƒ¢ãƒ‡ãƒ«è¨­å®š -->
    <div class="card">
      <h2>ğŸ¤– ãƒ¢ãƒ‡ãƒ«è¨­å®š</h2>
      <form id="model-form">
        <div class="form-group">
          <label for="model_id" class="form-label">Whisperãƒ¢ãƒ‡ãƒ«</label>
          <select name="model_id" id="model_id" class="form-select">
            <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
          </select>
          <div class="form-help">
            ãƒ¢ãƒ‡ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã„ã»ã©ç²¾åº¦ãŒé«˜ããªã‚Šã¾ã™ãŒã€å‡¦ç†æ™‚é–“ã‚‚é•·ããªã‚Šã¾ã™
          </div>
          <div id="selected-model-info" class="model-info" style="display: none;">
            <span class="label">ã‚µã‚¤ã‚º:</span>
            <span class="value" id="model-size">-</span>
            <span class="label">é€Ÿåº¦:</span>
            <span class="value" id="model-speed">-</span>
          </div>
        </div>

        <div class="form-group">
          <label for="compute_type" class="form-label">è¨ˆç®—ç²¾åº¦</label>
          <select name="compute_type" id="compute_type" class="form-select">
            <option value="int8">int8 (æ¨å¥¨ - é«˜é€Ÿ)</option>
            <option value="int8_float16">int8_float16 (ãƒãƒ©ãƒ³ã‚¹)</option>
            <option value="float16">float16 (é«˜ç²¾åº¦)</option>
            <option value="float32">float32 (æœ€é«˜ç²¾åº¦)</option>
          </select>
          <div class="form-help">
            int8ãŒæœ€ã‚‚é«˜é€Ÿã§ã€float32ãŒæœ€ã‚‚é«˜ç²¾åº¦ã§ã™
          </div>
        </div>
      </form>
    </div>

    <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š -->
    <div class="card">
      <h2>ğŸŒ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š</h2>
      <form id="defaults-form">
        <div class="form-group">
          <label for="default_language" class="form-label">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨€èª</label>
          <select name="default_language" id="default_language" class="form-select">
            <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
          </select>
          <div class="form-help">
            æ–°è¦æ–‡å­—èµ·ã“ã—æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨€èªè¨­å®š
          </div>
        </div>

        <div class="form-group">
          <label for="default_task" class="form-label">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¹ã‚¯</label>
          <select name="default_task" id="default_task" class="form-select">
            <option value="transcribe">æ–‡å­—èµ·ã“ã—</option>
            <option value="translate">ç¿»è¨³ï¼ˆæ—¥æœ¬èªï¼‰</option>
          </select>
          <div class="form-help">
            æ–°è¦å‡¦ç†æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¹ã‚¯è¨­å®š
          </div>
        </div>

        <div class="form-group">
          <label for="max_workers" class="form-label">æœ€å¤§åŒæ™‚å‡¦ç†æ•°</label>
          <select name="max_workers" id="max_workers" class="form-select">
            <option value="1">1 (æœ€ã‚‚å®‰å®š)</option>
            <option value="2">2 (æ¨å¥¨)</option>
            <option value="3">3 (é«˜æ€§èƒ½PCå‘ã‘)</option>
            <option value="4">4 (ãƒã‚¤ã‚¨ãƒ³ãƒ‰)</option>
          </select>
          <div class="form-help">
            åŒæ™‚ã«å®Ÿè¡Œã§ãã‚‹æ–‡å­—èµ·ã“ã—å‡¦ç†ã®æ•°
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
  <div class="card">
    <div class="btn-group">
      <button type="button" class="btn btn-secondary" onclick="loadCurrentConfig()">
        ğŸ”„ è¨­å®šã‚’å†èª­ã¿è¾¼ã¿
      </button>
      <button type="button" class="btn btn-primary" onclick="saveConfig()">
        ğŸ’¾ è¨­å®šã‚’ä¿å­˜
      </button>
    </div>
  </div>

  <script>
    let currentConfig = {};
    let availableModels = [];
    let availableLanguages = [];

    // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
    function showAlert(message, type = 'success') {
      const container = document.getElementById('alert-container');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      
      container.innerHTML = '';
      container.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    // ç¾åœ¨ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿
    async function loadCurrentConfig() {
      try {
        const response = await fetch('/api/config');
        currentConfig = await response.json();
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã«è¨­å®šå€¤ã‚’åæ˜ 
        document.getElementById('model_id').value = currentConfig.model_id || '';
        document.getElementById('compute_type').value = currentConfig.compute_type || 'int8';
        document.getElementById('default_language').value = currentConfig.default_language || '';
        document.getElementById('default_task').value = currentConfig.default_task || 'transcribe';
        document.getElementById('max_workers').value = currentConfig.max_workers || 2;
        
        updateModelInfo();
        showAlert('è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
      } catch (error) {
        console.error('Failed to load config:', error);
        showAlert('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      }
    }

    // ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadModels() {
      try {
        const response = await fetch('/api/models');
        availableModels = await response.json();
        
        const select = document.getElementById('model_id');
        select.innerHTML = '';
        
        availableModels.forEach(model => {
          const option = document.createElement('option');
          option.value = model.id;
          option.textContent = `${model.id} (${model.size})`;
          select.appendChild(option);
        });
        
        // ç¾åœ¨ã®è¨­å®šå€¤ã‚’åæ˜ 
        if (currentConfig.model_id) {
          select.value = currentConfig.model_id;
        }
        
        updateModelInfo();
      } catch (error) {
        console.error('Failed to load models:', error);
        showAlert('ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    // è¨€èªä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadLanguages() {
      try {
        const response = await fetch('/api/languages');
        availableLanguages = await response.json();
        
        const select = document.getElementById('default_language');
        select.innerHTML = '';
        
        availableLanguages.forEach(lang => {
          const option = document.createElement('option');
          option.value = lang.code;
          option.textContent = lang.name;
          select.appendChild(option);
        });
        
        // ç¾åœ¨ã®è¨­å®šå€¤ã‚’åæ˜ 
        if (currentConfig.default_language) {
          select.value = currentConfig.default_language;
        }
      } catch (error) {
        console.error('Failed to load languages:', error);
        showAlert('è¨€èªä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    // ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’èª­ã¿è¾¼ã¿
    async function loadSystemStatus() {
      try {
        const response = await fetch('/api/status');
        const status = await response.json();
        
        const content = document.getElementById('status-content');
        content.innerHTML = `
          <div class="status-item">
            <span class="status-label">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹:</span>
            <span class="status-value">${status.status === 'running' ? 'ğŸŸ¢ å‹•ä½œä¸­' : 'ğŸ”´ åœæ­¢ä¸­'}</span>
          </div>
          <div class="status-item">
            <span class="status-label">ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿:</span>
            <span class="status-value">${status.model_loaded ? 'ğŸŸ¢ æ¸ˆã¿' : 'ğŸŸ¡ æœªèª­ã¿è¾¼ã¿'}</span>
          </div>
          <div class="status-item">
            <span class="status-label">å‡¦ç†ä¸­ã‚¸ãƒ§ãƒ–:</span>
            <span class="status-value">${status.active_jobs} ä»¶</span>
          </div>
          <div class="status-item">
            <span class="status-label">ç·ã‚¸ãƒ§ãƒ–æ•°:</span>
            <span class="status-value">${status.total_jobs} ä»¶</span>
          </div>
          <div class="status-item">
            <span class="status-label">ç¾åœ¨ã®ãƒ¢ãƒ‡ãƒ«:</span>
            <span class="status-value">${status.current_config.model_id || 'base'}</span>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load system status:', error);
        document.getElementById('status-content').innerHTML = 'âš ï¸ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
      }
    }

    // ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã‚’æ›´æ–°
    function updateModelInfo() {
      const modelSelect = document.getElementById('model_id');
      const infoDiv = document.getElementById('selected-model-info');
      const selectedModel = availableModels.find(m => m.id === modelSelect.value);
      
      if (selectedModel) {
        document.getElementById('model-size').textContent = selectedModel.size;
        document.getElementById('model-speed').textContent = selectedModel.speed;
        infoDiv.style.display = 'grid';
      } else {
        infoDiv.style.display = 'none';
      }
    }

    // è¨­å®šã‚’ä¿å­˜
    async function saveConfig() {
      try {
        const formData = {
          model_id: document.getElementById('model_id').value,
          compute_type: document.getElementById('compute_type').value,
          default_language: document.getElementById('default_language').value,
          default_task: document.getElementById('default_task').value,
          max_workers: parseInt(document.getElementById('max_workers').value)
        };
        
        const response = await fetch('/api/config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        showAlert(result.message, 'success');
        
        // ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
        setTimeout(loadSystemStatus, 1000);
        
      } catch (error) {
        console.error('Failed to save config:', error);
        showAlert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById('model_id').addEventListener('change', updateModelInfo);

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      await loadCurrentConfig();
      await loadModels();
      await loadLanguages();
      await loadSystemStatus();
      
      // å®šæœŸçš„ã«ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
      setInterval(loadSystemStatus, 10000);
    });
  </script>
</body>
</html>
